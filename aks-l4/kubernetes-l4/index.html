<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=ja-jp lang=ja-jp><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Kubernetesクラスターに対するL4ネットワークアクセス制御を整理する &#183; ASA Blog</title><meta name=description content="Kubernetesクラスターに対するL4ネットワークアクセス制御をAzure Kubernetes Serviceを例にして整理しました。"><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link type=text/css rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.6/css/all.css><link type=text/css rel=stylesheet href=https://aakira.app/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css integrity=sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0 crossorigin=anonymous><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css integrity=sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js integrity=sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js integrity=sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF crossorigin=anonymous onload=renderMathInElement(document.body);></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\[",right:"\\]",display:true},{left:"$",right:"$",display:false},{left:"\\(",right:"\\)",display:false}]});});</script><meta property="og:site_name" content="ASA Blog"><meta property="og:title" content="Kubernetesクラスターに対するL4ネットワークアクセス制御を整理する"><meta property="og:url" content="https://asashiho.github.io/aks-l4/kubernetes-l4/"><meta property="og:type" content="article"><meta name=twitter:card content="summary"><meta name=twitter:site content="@_dr_asa"><meta name=twitter:creator content="@_dr_asa"><meta property="twitter:title" content="Kubernetesクラスターに対するL4ネットワークアクセス制御を整理する"><meta property="og:description" content="Kubernetesクラスターに対するL4ネットワークアクセス制御をAzure Kubernetes Serviceを例にして整理しました。"><meta property="twitter:description" content="Kubernetesクラスターに対するL4ネットワークアクセス制御をAzure Kubernetes Serviceを例にして整理しました。"><meta property="og:image" content="https://asashiho.github.io/thumbnails/prof.jpg"><meta property="og:image:url" content="https://asashiho.github.io/thumbnails/prof.jpg"></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://asashiho.github.io/><h1>ASA Blog</h1></a><p class=lead>enjoy a laid-back life</p></div><nav><ul class=sidebar-nav><li><a href=https://asashiho.github.io/>Home</a></li><li><a href=https://github.com/asashiho/>GitHub</a></li><li><a href=https://www.linkedin.com/in/shiho-asa/>LinkedIn</a></li></ul></nav><p>&copy; 2020. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Kubernetesクラスターに対するL4ネットワークアクセス制御を整理する</h1><time datetime=2020-05-08T00:00:00Z class=post-date>Fri, May 8, 2020</time>
<a href="http://twitter.com/intent/tweet?url=https%3a%2f%2fasashiho.github.io%2faks-l4%2fkubernetes-l4%2f&text=Kubernetes%e3%82%af%e3%83%a9%e3%82%b9%e3%82%bf%e3%83%bc%e3%81%ab%e5%af%be%e3%81%99%e3%82%8bL4%e3%83%8d%e3%83%83%e3%83%88%e3%83%af%e3%83%bc%e3%82%af%e3%82%a2%e3%82%af%e3%82%bb%e3%82%b9%e5%88%b6%e5%be%a1%e3%82%92%e6%95%b4%e7%90%86%e3%81%99%e3%82%8b" target=_blank title=Tweet><i class="fab fa-twitter"></i></a>&ensp;
<a href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fasashiho.github.io%2faks-l4%2fkubernetes-l4%2f&t=Kubernetes%e3%82%af%e3%83%a9%e3%82%b9%e3%82%bf%e3%83%bc%e3%81%ab%e5%af%be%e3%81%99%e3%82%8bL4%e3%83%8d%e3%83%83%e3%83%88%e3%83%af%e3%83%bc%e3%82%af%e3%82%a2%e3%82%af%e3%82%bb%e3%82%b9%e5%88%b6%e5%be%a1%e3%82%92%e6%95%b4%e7%90%86%e3%81%99%e3%82%8b" target=_blank title=Facebook><i class="fab fa-facebook"></i></a>&ensp;
<a href="https://plus.google.com/share?url=https%3a%2f%2fasashiho.github.io%2faks-l4%2fkubernetes-l4%2f" target=_blank title=google+><i class="fab fa-google-plus"></i></a><hr><p>お仕事でプリセールスをしているため、お客様やSIパートナー様といっしょに「高い安全性が求められるシステム」について議論することが多くあります。</p><p>いわゆるクラウドネイティブアプリケーションの場合、クラウド時代の脅威に対応するためには「 <strong>内部を（ユーザーも含めて）信頼しない</strong> 」という考え方を前提に考えることが適していたりします。</p><blockquote><blockquote><p>境界ベースのセキュリティからゼロトラスト セキュリティへの移行</p></blockquote><p>従来のセキュリティ モデルでは、組織のアプリケーションはプライベート データセンターの外部ファイアウォールに依存して、受信トラフィックを保護できません。クラウド ネイティブ環境でも、BeyondCorp モデルと同様にネットワーク境界を引き続き保護する必要がありますが、境界ベースのセキュリティ モデルでは十分に保護できません。新しいセキュリティ上の問題が発生するわけではありませんが、ファイアウォールで企業ネットワークを完全に保護できなければ、本番環境ネットワークも完全に保護できません。ゼロトラスト セキュリティ モデルでは、内部トラフィックが暗黙に信頼されず、認証や暗号化などのセキュリティ制御が必要になります。同時に、マイクロサービスへの移行は、従来のセキュリティ モデルを再検討する機会となります。単一のネットワーク境界（1 つのファイアウォールなど）への依存を排除すると、ネットワークをサービスごとに分割できるようになります。このアイデアをさらに進めて、サービス間に固有の相互信頼関係をなくして、マイクロサービス レベルのセグメンテーションを実装することもできます。マイクロサービスでは、トラフィックの信頼度がさまざまであるため、内部トラフィックと外部トラフィックを比較するだけでは済みません。</p><p>引用:<a href=https://cloud.google.com/security/beyondprod>BeyondProd: クラウド ネイティブ セキュリティに対する新しいアプローチ</a>より</p></blockquote><p>とはいうものの、、、オンプレミス環境などでシステムを運用しているケースでは境界型モデルが馴染みが深く、まず最初に方式設計の検討テーマに上がります。</p><p>このブログでは、Kubernetesクラスターへのネットワークアクセスについて私自身が検証していて気づいたことをホワイトボードに書く感覚で、だらだらと書きとめます。</p><p>※ なお「Kuberntesのセキュリティ対策はネットワークアクセス制御さえすれば安全といえよう！」のようなシンプルなものではなく、認証認可・イメージの脆弱性検査・特権エスカレーションの阻止などなどなどなどなど、多岐にわたります。Kuberntesに対する脅威はこちらの「<a href="https://www.microsoft.com/security/blog/2020/04/02/attack-matrix-kubernetes/?utm_sq=gdqrz3t4da">Attack matrix for Kubernetes</a>」にまとまっておりますので、ぜひ。</p><h1 id=kubernetesクラスターへの2つのアクセス経路>Kubernetesクラスターへの2つのアクセス経路</h1><p>Kubernetesクラスターを運用環境で稼働させるとき、安全なアクセス経路を検討するには、次の2つを考える必要があります。</p><p>なお、分かりやすさ重視のため「ほげ銀行」という妄想上の企業の社内システムを例に説明しています。</p><h4 id=1-kubernetesクラスター上で動かすアプリに対するアクセス>1. Kubernetesクラスター上で動かすアプリに対するアクセス</h4><p>主にシステム利用者がKubernetesクラスター上で動くWebアプリケーションにアクセスするときのアクセス経路です。たとえば、ほげ銀行では市場国際部門・与信管理部門・証券投資部門のユーザがそれぞれの業務を行うためのアプリケーションにアクセスします。</p><h4 id=2-kubernetesクラスター管理のためのコントロープレーンに対するアクセス>2. Kubernetesクラスター管理のためのコントロープレーンに対するアクセス</h4><p>Kubernetesクラスターへのアプリのデプロイやクラスターの運用などでKubernetesのAPI Serverに対してアクセスするための経路です。クラスターに対して強い権限が必要になるため、限られたアクセス経路からのみ通信できる必要があります。</p><p><img src=../docs/images/2020-05-06-20-44-10.png alt></p><p>今回のブログは、1.のケースのアクセス経路についてのみ整理します。</p><p>(この話をごちゃごちゃ混乱させずに文章で説明する能力がないので2.のプライベートクラスターのケースについては、別ブログにて改めて)</p><hr><h2 id=境界型モデルによるネットワークアクセスコントロール>境界型モデルによるネットワークアクセスコントロール</h2><p>従来のオンプレミス型のシステムの場合、業務システムへのアクセスは、すべてのトラフィックをFWを介してコントロールする場合が多いと思います。</p><p>基本的に社内システムはプライベートな閉塞区間で運用し、社外への通信が必要な場合はバリアセグメントを設け、そこを経由することでアクセスコントロール・監査・Lockdownを1か所で行う、という考え方です。</p><p><img src=../docs/images/2020-05-06-20-47-52.png alt></p><p>たとえば、Azureの場合、Azure Kubernetes Service(AKS)のアクセス制御するときは以下のようなアーキテクチャになります。</p><p>このクラスタ外に配置したAzure Firewallの主な目的は、組織がAKSクラスターに対して細かくIngressおよびEgress Traffic規則を設定できるようにすることです。</p><p><img src=https://docs.microsoft.com/ja-jp/azure/aks/media/egress-outboundtype/outboundtype-udr.png alt></p><p>たとえばこの構成例では、Ingress Trafficはファイアウォール フィルターの経由が強制されています。
またEgress Trafficはユーザー定義ルートを使用して、NodeからAzure FirewallのInternal IPを介して、パブリックインターネットまたはその他のAzureサービスへのアクセスは、FWのPublic IPで行われます。</p><p>またAKSの場合、クラスターが機能するには、<a href=https://docs.microsoft.com/ja-jp/azure/aks/egress>必須のEgress Endpoint</a>で定義されているすべてのEndpointをアプリケーション ファイアウォール規則で有効にする必要があります。 これらのエンドポイントが有効ではない場合、クラスターは正しく動かないので注意してください。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az network firewall application-rule create -g $RG -f $FWNAME <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --collection-name <span style=color:#e6db74>&#39;AKS_Global_Required&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --action allow <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --priority <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -n <span style=color:#e6db74>&#39;required&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --source-addresses <span style=color:#e6db74>&#39;*&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --protocols <span style=color:#e6db74>&#39;http=80&#39;</span> <span style=color:#e6db74>&#39;https=443&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --target-fqdns <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;aksrepos.azurecr.io&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;*blob.core.windows.net&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;mcr.microsoft.com&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;*cdn.mscr.io&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;*.data.mcr.microsoft.com&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;management.azure.com&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;login.microsoftonline.com&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;ntp.ubuntu.com&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;packages.microsoft.com&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;acs-mirror.azureedge.net&#39;</span>
</code></pre></div><p>詳しい手順は<a href=https://github.com/asashiho/aks-firewall>こちら</a>にまとめましたので、興味のある方はお試しください。ただし、この構成は執筆時点ではプレビュー機能になりますので、プロダクション環境では利用しないようにしてください。</p><p>また、AKSもAzure Firewallもそれなりに料金がかかりますので、検証がおわったらきちんとリソースを削除しておきましょう！</p><h2 id=ゼロトラスト型のネットワークアクセスコントロール>ゼロトラスト型のネットワークアクセスコントロール</h2><p>境界型によるアクセスコントロールは、オンプレミス環境などでは広く採用されていて、この境界型を前提にして運用組織体制やガバナンス・法規制などが行われています。</p><p>一方のクラウドネイティブアプリケーションではマイクロサービスアーキテクチャで実装されることが増えてきています。マイクロサービスアーキテクチャとは、機能単位に分割されたマイクロサービスの集合体として1つのサービスを構築してしまう考え方です。</p><p>分散システムにおいて複数のサービスが相互に通信する環境においては、従来のようにネットワークドメインの境界にファイアーウォールを設置するようなセキュリティの設計では、さまざまな脅威に対する対策としては不十分になってきます。そのため、 <strong>サービス単位にファイアーウォールを設定</strong> し、アクセスを制限するという考え方が重要になってきます。</p><h3 id=kubernetes-serviceによるl4アクセスコントロール>Kubernetes ServiceによるL4アクセスコントロール</h3><p>たとえばKubernetesでは、「<strong>Service</strong>」リソースを使用して、一連のアプリケーションを論理的にグループ化してアクセスコントロールができます。</p><p>AKSでは、Azure Loadbalancerを使って、外部IPアドレスを構成し、要求されたバックエンド プールに接続します。</p><p><img src=https://docs.microsoft.com/ja-jp/azure/aks/media/concepts-network/aks-loadbalancer.png alt></p><p>詳細な手順は<a href=https://github.com/asashiho/aks-firewall>こちら</a>にまとめましたので、ポイントだけ。</p><p>まず、以下のシンプルなServiceリソースを作成します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: v1
<span style=color:#66d9ef>kind</span>: Service
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: nginx-service
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>type</span>: LoadBalancer
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>app</span>: nginx
  <span style=color:#66d9ef>ports</span>:
    - <span style=color:#66d9ef>name</span>: http
      <span style=color:#66d9ef>port</span>: <span style=color:#ae81ff>80</span>
      <span style=color:#66d9ef>targetPort</span>: <span style=color:#ae81ff>80</span>
</code></pre></div><p>次のコマンドでリソースをクラスターに展開します。</p><pre><code>kubectl apply -f loadbalancer.yaml
</code></pre><p>これにより、クラスター外部からアクセス可能なEXTERNAL-IPが払い出されます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get service

NAME         TYPE           CLUSTER-IP     EXTERNAL-IP    PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>        AGE
kubernetes   ClusterIP      10.0.0.1       &lt;none&gt;         443/TCP        12m
nginx        LoadBalancer   10.0.177.222   20.44.173.77   80:32076/TCP   33s
</code></pre></div><p>ここで、払い出されたアドレスに対して、アクセスしましょう。問題なくWebサイトにアクセスできるのが分かります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl http://20.44.173.77/

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
...
&lt;/head&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div><p>ここで、AKSクラスター内に作成されたAzure Network Security Group(NSG)を確認してみます。NSGとはAzureが提供するケットフィルタリングの設定の許可・拒否を行うサービスです。Amazon VPCのネットワークACLのようなものです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az network nsg rule list <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --nsg-name $AKS_NSG <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -g $AKS_NODE_RG <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -o table

Name                                              ResourceGroup                     Priority    SourcePortRanges    SourceAddressPrefixes    SourceASG    Access    Protocol    Direction    DestinationPortRanges    DestinationAddressPrefixes    DestinationASG
------------------------------------------------  --------------------------------  ----------  ------------------  -----------------------  -----------  --------  ----------  -----------  -----------------------  ----------------------------  ----------------
ab033568af7ac4439bf867f26cada197-TCP-80-Internet  mc_hoge-bank-lb-rg_aks_japaneast  <span style=color:#ae81ff>500</span>         *                   Internet                 None     
    Allow     Tcp         Inbound      <span style=color:#ae81ff>80</span>                       20.44.173.77                  None
</code></pre></div><p>これをみると、Internetからの80番ポートのInboundアクセスが許可されるルールが追加されていることが分かります。</p><p>このように <strong>kubectlコマンドでAKSのServiceを作成しただけで、AzureのNSGの設定が書き換わっている</strong> というのが分かります。</p><hr><p>次は特定のアドレスからのみアクセスを許可させるようServiceのルールを設定変更します。</p><p>次のコマンドで自分のIPアドレスを調べます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>curl globalip.me
<span style=color:#ae81ff>39.110</span>.xxx.xxx
</code></pre></div><p>先ほどのServiceのマニュフェストに以下のようにSourceRangesを設定します。ここで指定したアドレスからのみ接続を許可します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>type</span>: LoadBalancer
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>app</span>: nginx
  <span style=color:#66d9ef>loadBalancerSourceRanges</span>:
  - <span style=color:#ae81ff>39.110</span>.xxx.xxx/<span style=color:#ae81ff>32</span>
</code></pre></div><p>次のコマンドで、マニュフェストの変更をKubernetes APIに対して通知します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f loadbalancer.yaml
</code></pre></div><p>ここで、再びNGSのルールを確認します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az network nsg rule list <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --nsg-name $AKS_NSG <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -g $AKS_NODE_RG <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -o table
</code></pre></div><p><code>SourcePortRanges</code>がInternetから<code>39.110.xxx.xxx/32</code>に書き換わっているのが分かります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Name                                                      ResourceGroup                                                            Priority    SourcePortRanges    SourceAddressPrefixes    SourceASG    Access    Protocol    Direction    DestinationPortRanges    DestinationAddressPrefixes    DestinationASG
--------------------------------------------------------  -----------------------------------------------------------------------  ----------  ------------------  -----------------------  -----------  --------  ----------  -----------  -----------------------  ----------------------------  ----------------
a89bb8932c6a54edcab0055ee4330474-TCP-80-39.110.159.85_32  mc_hoge-bank-networkpolicy41-rg_hoge-bank-networkpolicy41-aks_japaneast  <span style=color:#ae81ff>500</span>         *      
             39.110.xxx.xxx/32         None         Allow     Tcp         Inbound      <span style=color:#ae81ff>80</span>                       20.44.173.105                 None   
</code></pre></div><p>ここで疎通確認します。
39.110.xxx.xxxからのアクセスは許可されますが、それ以外のSourceからのアクセスは拒否されているのが分かります。</p><h3 id=aksでazure-loadbalancerにパブリックipを設定しないように構成する>AKSでAzure LoadbalancerにパブリックIPを設定しないように構成する</h3><p>AKSではKubernetes Serviceリソースを作成すると、どうやら内部で使用されているAzure Load Balancerが自動で作成され、Serviceの設定内容によって構成が変更されているぽいぞということが確認できました。</p><p>デフォルトではServiceから作成Azure LoadbalancerにはパブリックIPアドレスが割り当てられています。Azureの世界ではこれを外部Load Balancerと呼んだりしています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az network public-ip list -g $AKS_RES_RG -o table
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Name                                         ResourceGroup                     Location    Zones    Address       AddressVersion    AllocationMethod  
  IdleTimeoutInMinutes    ProvisioningState
-------------------------------------------  --------------------------------  ----------  -------  ------------  ----------------  ------------------  ----------------------  -------------------
1adbb0ce-665e-4876-9836-1f2bfe85534e         MC_hoge-bank-lb-rg_aks_japaneast  japaneast            20.44.169.1   IPv4              Static
  <span style=color:#ae81ff>30</span>                      Succeeded
</code></pre></div><p>インターネットからの送信を拒否したい場合は、Serviceのアノテーションに以下の値を設定をします。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  annotations:
    service.beta.kubernetes.io/azure-load-balancer-internal: <span style=color:#e6db74>&#34;true&#34;</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f loadbalancer.yaml
</code></pre></div><p>しばらくして、次のコマンドでKubernetesのServiceを確認します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get svc

NAME         TYPE           CLUSTER-IP     EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>        AGE
kubernetes   ClusterIP      10.0.0.1       &lt;none&gt;        443/TCP        57m
nginx        LoadBalancer   10.0.177.222   10.240.0.35   80:32076/TCP   45m
</code></pre></div><p>EXTERNAL-IPにローカルIPが割り当てられているのがわかります。これはAzureの世界でいう内部Load Balancerになります。</p><p>このように、AKSでServiceを作成するとAzureのNSGか自動で更新されているのが分かりました。なおこのルールや設定を手動で書き換えるとAKSのサポート外になるので<a href=https://docs.microsoft.com/ja-jp/azure/aks/support-policies#network-ports-access-and-nsgs>注意</a>してください。</p><h3 id=podレベルで細かくアクセスコントロールするには>Podレベルで細かくアクセスコントロールするには？</h3><p>Kubernetes NetworkPolicyを使用すると、クラスター内のPod間のIngressおよびEgress Trafficのアクセスをコントロールできます。Kubernetes Network Policyは、Podレベルのファイアーウォールルールを提供するセキュリティ機能です。トラフィックを送受信するための順序付けされたルールセットを定義し、ラベルセレクターに一致するPodのコレクションに適用できます。</p><p><img src=../docs/images/2020-05-06-20-59-13.png alt></p><p>なおNetwork Policyを使用するには、ネットワークプラグイン側がそれに対応した機能を持っている必要があります。</p><p>現在Kubernetesが対応しているネットワークプラグインは、Calico、Weave、Ciliumなどがあり、AKSの場合、Azure NetworkPolicyまたはCalicoが選べます。どちらの実装も Linux IP Tables を使用して、指定されたポリシーを適用します。両者の違いについては<a href=https://docs.microsoft.com/ja-jp/azure/aks/use-network-policies#differences-between-azure-and-calico-policies-and-their-capabilities>こちら</a>で。</p><p>なお、KubernetesのNetwork PolicyはAzureのNSGでの制御ではなくKubernetes内のコンポーネントだけで動作するところが、<code>Service</code>の<code>Type:Loadbalancer</code>との違いです。</p><p>細かい手順については<a href=https://github.com/asashiho/aks-firewall>こちら</a>にまとめていますので、ポイントだけ。</p><p>たとえばIPアドレスによるコントロールをしたい場合は、次のようにマニュフェストファイルを作成します。
もちろん、実運用時はよく利用するであろうNamespaceやPodのLabelによって細かくアクセスコントロールできます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>kind</span>: NetworkPolicy
<span style=color:#66d9ef>apiVersion</span>: networking.k8s.io/v1
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: nginx-policy
  <span style=color:#66d9ef>namespace</span>: default

<span style=color:#75715e># すべてのインバウンド/アウトバウンドを拒否</span>
<span style=color:#75715e># spec:</span>
<span style=color:#75715e>#   podSelector: {}</span>
<span style=color:#75715e>#   policyTypes:</span>
<span style=color:#75715e>#   - Ingress</span>
<span style=color:#75715e>#   - Egress</span>

<span style=color:#75715e># すべてのインバウンドを許可</span>
<span style=color:#75715e># spec:</span>
<span style=color:#75715e>#   podSelector: {}</span>
<span style=color:#75715e>#   ingress:</span>
<span style=color:#75715e>#   - {}</span>

<span style=color:#75715e># ポリシーを適用するPodの条件</span>
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>podSelector</span>: 
    <span style=color:#66d9ef>matchLabels</span>:
      <span style=color:#66d9ef>app</span>: nginx
  <span style=color:#66d9ef>policyTypes</span>:
  - Ingress <span style=color:#75715e># Ingressトラフィックをすべて拒否</span>
  <span style=color:#75715e>#- Egress  # Egressトラフィックをすべて拒否</span>
  <span style=color:#66d9ef>ingress</span>:  <span style=color:#75715e># 許可するIngressトラフィックの条件</span>
  - <span style=color:#66d9ef>from</span>:
    - <span style=color:#66d9ef>ipBlock</span>:
        <span style=color:#66d9ef>cidr</span>: <span style=color:#ae81ff>39.110</span>.xxx.xxxx/<span style=color:#ae81ff>32</span>
</code></pre></div><p>Network Policyのマニフェストファイルの書式そのものについては<a href=https://kubernetes.io/docs/concepts/services-networking/network-policies/>Kubernetes公式サイト</a>やその他分かりやすいサイトや書籍におまかせします。</p><p>が、NetworkPolicyのルールは、Kubernetesのマニフェストとして定義でき、Kubernetesの他のリソースと同様にソースコードとして管理できます。これはとても重要なポイント⤴です。</p><h1 id=なぜkubernetesのserviceを作成するとazure-load-barancerが勝手に作成されたのか>なぜ、KubernetesのServiceを作成すると、Azure Load Barancerが勝手に作成されたのか？</h1><p>では、これまでの挙動をもう少しだけ深堀りします。</p><p>Azure Kubernetes Service(AKS)は、Kubernetesの機能を提供するマネージドサービスです。コントロールプレーンはMicrosoftが管理することで、一般的に技術的難易度が高いと言われているKubernetesクラスターを手軽に従量課金制で利用できるサービスです。</p><p>もうちょっというと、<strong>AKSはAzureのさまざまなサービス群を材料としてつかってMicrosoftのエンジニアが構築・運用するKubernetesクラスター</strong> です。</p><p>あまり知られていませんが、Microsoft社内にはKuberntesや周辺プロジェクトのUpstreamに貢献するソフトウエアエンジニアがたくさんいます。彼らがAKSの開発に携わっています。</p><h2 id=kubernetesクラウドコントローラーマネージャー>Kubernetesクラウドコントローラーマネージャー</h2><p>料理と同じですが、AKSのネットワーク部分ではAzure Networking群のサービスが材料として使われています。</p><p>たとえば、さきほどの検証で確認した通り、KubernetesのServiceを作成しただけで、裏でAzure Load Balancerが作成されていたのがわかりました。このAzure Load Balancerの実装は<a href=https://qiita.com/OpenJNY/items/6c5e6614868c732dff3b>Azure Ananta</a>というSoftware LBです。</p><p>これがGKEの場合はServiceで<a href=https://cloud.google.com/load-balancing/docs/network>External TCP/UDP Network Load Balancing</a>が作成され、これはAndromeda virtual networkingや<a href=https://www.school.ctc-g.co.jp/columns/nakai2/nakai201.html>Google Maglev</a>などで実装されています。</p><p>当然Azure畑で収穫した材料とGoogle Cloud畑で収穫した材料では、味や形、歯ごたえや風味が違います。</p><p>ではレシピにあたる「どのような方法で作っているか？」についてはどうなっているのかというと、Kubernetesでクラウドに依存している部分を吸収して実装するしくみが <strong>Cloud Controller Manager(CCM)</strong> です。</p><p><img src=https://d33wubrfki0l68.cloudfront.net/e298a92e2454520dddefc3b4df28ad68f9b91c6f/70d52/images/docs/pre-ccm-arch.png alt></p><p>CCMは次の調整ループを動かします。</p><h4 id=node-controller>Node controller</h4><p>ノードコントローラーは、クラウドプロバイダーからクラスター内で稼働しているノードの情報を取得し、初期化する責務を持ちます。</p><h4 id=route-controller>Route controller</h4><p>ルートコントローラーは、クラスター内の異なるノード上で稼働しているコンテナが相互に通信出来るように、クラウド内のルートを適切に設定する責務を持ちます。</p><h4 id=service-controller>Service controller</h4><p>サービスコントローラーは、サービスの作成、更新、そして削除イベントの待ち受けに責務を持ちます。Kubernetes内のサービスの現在の状態を、クラウド上のロードバランサーに反映するための設定を行います。そして、クラウドロードバランサーのバックエンドが最新の状態になっていることを保証します。</p><h3 id=ちなみにaksの内部ではどのようなネットワークサービスが利用されているか>ちなみに、AKSの内部ではどのようなネットワークサービスが利用されているか？</h3><p>では、AKSではどのようなAzureのサービスを材料としてつかっているのかを、Network部分に限ってみていきます。AKSクラスターを作成すると、オプションや構成にもよりますが、以下のサービス群がデプロイされてるのが確認できます。</p><h4 id=azure-virtual-networkdocsmicrosoftcomja-jpazureaksconcepts-networkazure-virtual-networks><a href=docs.microsoft.com/ja-jp/azure/aks/concepts-network#azure-virtual-networks>Azure Virtual Network</a></h4><p>Virtual Networkと接続したりVPN Gatewayを配置してオンプレミスなどと接続したりできます。</p><h4 id=azure-network-security-grouphttpsdocsmicrosoftcomja-jpazureaksconcepts-networknetwork-security-groups><a href=https://docs.microsoft.com/ja-jp/azure/aks/concepts-network#network-security-groups>Azure Network Security Group</a></h4><p>Virtual Network外との通信においてアクセス制御を行います。</p><h4 id=azure-application-gatewayhttpsdocsmicrosoftcomja-jpazureapplication-gatewayingress-controller-overview><a href=https://docs.microsoft.com/ja-jp/azure/application-gateway/ingress-controller-overview>Azure Application Gateway</a></h4><p>KubernetesのリソースであるIngress Controllerとして利用されます。</p><h4 id=azure-dnshttpsdocsmicrosoftcomja-jpazuredns><a href=https://docs.microsoft.com/ja-jp/azure/dns/>Azure DNS</a></h4><p>AKSのアドオンで、Kubernetesで作成したIngressに対し外部から解決できる名前をAzure DNSに登録できます。Load Balancerのルール更新などは、サービスプリンシパルを用いて行われます。</p><h4 id=azure-load-balancerhttpsgithubcomkubernetes-sigscloud-provider-azuretreemasterdocsservices><a href=https://github.com/kubernetes-sigs/cloud-provider-azure/tree/master/docs/services>Azure Load Balancer</a></h4><p>KubernetesのServiceが追加されたときに利用されます。Serviceにアノテーションを付けて、使用可能なロードバランサーを自動的に選択できます。ただし、AzureがLoad Balancerは、GCE/AWSとは異なり、複数のフロントエンドIP参照を設定できます。</p><p>詳細な挙動は<code>Service</code>の<code>Annotation</code>に、以下の値を設定することでコントロールできます。</p><table><thead><tr><th>Annotation</th><th>Value</th><th>Description</th></tr></thead><tbody><tr><td>service.beta.kubernetes.io/azure-load-balancer-internal</td><td>true or false</td><td>ロードバランサーを内部にするかどうかを指定。設定されていない場合は外部ロードバランサーとなる</td></tr><tr><td>service.beta.kubernetes.io/azure-load-balancer-internal-subnet</td><td>サブネット名</td><td>内部ロードバランサーをバインドするサブネットを指定</td></tr><tr><td>service.beta.kubernetes.io/azure-dns-label-name</td><td>DNSラベルの名前</td><td>サービスのDNSラベル名を指定</td></tr><tr><td>service.beta.kubernetes.io/azure-load-balancer-resource-group</td><td>リソースグループ名</td><td>クラスターと同じリソースグループにないロードバランサーオブジェクトのリソースグループを指定</td></tr><tr><td>service.beta.kubernetes.io/azure-load-balancer-tcp-idle-timeout</td><td>TCPアイドルタイムアウト(分単位)</td><td>ロードバランサーでTCP接続のアイドルタイムアウトが発生する時間を分単位で指定</td></tr></tbody></table><p>詳細については<a href=https://github.com/kubernetes-sigs/cloud-provider-azure/blob/master/docs/cloud-controller-manager.md>Kubernetes cloud-controller-manager for Azure</a>で確認できます。</p><h2 id=まとめ>まとめ</h2><p>Kubernetesクラスターに対するL4ネットワークアクセス制御を整理しましたが、</p><ul><li>Kubernetesのネットワークアクセスにはfromユーザー/fromシステム管理者の2種類あるので、ごっちゃにしない。</li><li>境界型の場合はFWを経由するアーキテクチャを構成しアクセスコントロールできる</li><li>ゼロトラスト型の場合はKubernetesのServiceやNetworkPolicyでアクセスコントロールできる<ul><li>Kubernetesのリソースを利用することでクラウドのレイヤーをある程度抽象化できる</li><li>CCMによってクラウドベンダーの実装の違いを吸収しているので、開発者からみると同様の手順でネットワークを利用できる</li></ul></li></ul><p>というところあたりが分かりました。</p><p>各社各システムごとに、セキュリティポリシーや運用体制・システムのミッションクリティカル度合い・関連法規やガイドライン・監査などを鑑みて、どこまでをクラウドインフラ側で担保し、どこからをKubernetesでやるかを方式設計に盛り込むことが重要ですが、その線引きは非常に難しいところです。</p><p>つづく</p></div></main></body></html>