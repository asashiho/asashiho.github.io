<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=ja-jp lang=ja-jp><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Spring WebFlux + KuberntesでアプリのGraceful Shutdownを実装する &#183; ASA Blog</title><meta name=description content="Spring WebFlux + KuberntesでアプリのGraceful Shutdownを実装する説明です。"><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link type=text/css rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.6/css/all.css><link type=text/css rel=stylesheet href=https://aakira.app/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css integrity=sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0 crossorigin=anonymous><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css integrity=sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js integrity=sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js integrity=sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF crossorigin=anonymous onload=renderMathInElement(document.body);></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\[",right:"\\]",display:true},{left:"$",right:"$",display:false},{left:"\\(",right:"\\)",display:false}]});});</script><meta property="og:site_name" content="ASA Blog"><meta property="og:title" content="Spring WebFlux + KuberntesでアプリのGraceful Shutdownを実装する"><meta property="og:url" content="https://asashiho.github.io/spring-graceful/spring-graceful/"><meta property="og:type" content="article"><meta name=twitter:card content="summary"><meta name=twitter:site content="@_dr_asa"><meta name=twitter:creator content="@_dr_asa"><meta property="twitter:title" content="Spring WebFlux + KuberntesでアプリのGraceful Shutdownを実装する"><meta property="og:description" content="Spring WebFlux + KuberntesでアプリのGraceful Shutdownを実装する説明です。"><meta property="twitter:description" content="Spring WebFlux + KuberntesでアプリのGraceful Shutdownを実装する説明です。"><meta property="og:image" content="https://asashiho.github.io/thumbnails/prof.jpg"><meta property="og:image:url" content="https://asashiho.github.io/thumbnails/prof.jpg"></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://asashiho.github.io/><h1>ASA Blog</h1></a><p class=lead>enjoy a laid-back life</p></div><nav><ul class=sidebar-nav><li><a href=https://asashiho.github.io/>Home</a></li><li><a href=https://github.com/asashiho/>GitHub</a></li><li><a href=https://www.linkedin.com/in/shiho-asa/>LinkedIn</a></li></ul></nav><p>&copy; 2021. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Spring WebFlux + KuberntesでアプリのGraceful Shutdownを実装する</h1><time datetime=2021-09-30T00:00:00Z class=post-date>Thu, Sep 30, 2021</time>
<a href="http://twitter.com/intent/tweet?url=https%3a%2f%2fasashiho.github.io%2fspring-graceful%2fspring-graceful%2f&text=Spring%20WebFlux%20%2b%20Kuberntes%e3%81%a7%e3%82%a2%e3%83%97%e3%83%aa%e3%81%aeGraceful%20Shutdown%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%99%e3%82%8b" target=_blank title=Tweet><i class="fab fa-twitter"></i></a>&ensp;
<a href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fasashiho.github.io%2fspring-graceful%2fspring-graceful%2f&t=Spring%20WebFlux%20%2b%20Kuberntes%e3%81%a7%e3%82%a2%e3%83%97%e3%83%aa%e3%81%aeGraceful%20Shutdown%e3%82%92%e5%ae%9f%e8%a3%85%e3%81%99%e3%82%8b" target=_blank title=Facebook><i class="fab fa-facebook"></i></a>&ensp;
<a href="https://plus.google.com/share?url=https%3a%2f%2fasashiho.github.io%2fspring-graceful%2fspring-graceful%2f" target=_blank title=google+><i class="fab fa-google-plus"></i></a><hr><p>最近業務でお手伝いさせていただく案件のなかでも、Java on Kubernetesなパターンが増えてきています。Kubernetesに限らずクラウドのマネージドPaaSで動かすにはアプリケーション側でもクラウドネイティブを考慮した実装が必要になり、特に耐障害性や回復性などを意識した実装が大事になってきます。</p><p>クラウドネイティブなアプリケーション方式設計されたシステムでは、大きな問題もなく開発者からみると「クラウド超便利」「マネージド最高か！」となりますが、ごくまれに「オンプレで動いていたそのままのアプリをクラウドに持ってきた」or「オンプレを前提とした開発手法で実装されたレガシーアプリをクラウドネイティブなPaaSサービスで動かしてみた」というケースで問題が発生することがあります。</p><hr><p>クラウドネイティブな環境でアプリケーションを動かすときに、開発者の観点でどういうところに注意すればよいかは</p><ul><li>通信先のサービス(DB/外部API)は常に動いていると思うべからず</li><li>死に際を美しく(Graceful Shutdown)</li><li>秘匿情報・環境依存値の取り扱い</li><li>ステートレスにすべし</li></ul><p>あたりが大事なポイントになってくるかなと思っています。</p><p>このエントリでは、2つ目の</p><p><strong>死に際を美しく(Graceful Shutdown)</strong></p><p>対策の一つであるアプリケーションのGraceful Shutdownの実装について、Spring Bootを使った実装の例を説明します。</p><h1 id=そもそもgraceful-shutdownとは>そもそも、Graceful Shutdownとは？</h1><p>従来のオンプレでのWeb3層システムの場合、システムメンテナンスなどでWebサーバを停止させる場合、システム運用者によって次の作業を行います。</p><ol><li>LBで該当Webサーバへの新規リクエストの受付を停止する</li><li>該当Webサーバ上で動くアプリケーションが処理し終わるのを待つ</li><li>処理中のプロセスが無いことを確認できたら、Webサーバを停止する</li></ol><p>クラウドネイティブな構成の場合、これらの処理をソフトウエアで自動化しています。たとえば、Kubernetesの場合、LBに相当するService/IngressからWebアプリケーションに相当するPodへのルーティングを宣言ベースで行い、クラスタの状態を維持します。またプラットフォームのメンテナンス等でPodが動いているWorker Nodeが移動するケースも普通にあります。また、Deploymentの更新などの理由でPodの再作成やPodの終了処理がいたるところで行われます。</p><hr><p>これらは基盤メンテチーム側からみると「Kubernetesのしくみをつかって工数のかかるWebサーバのメンテナンスを自動化した！生産性向上！ゆっくり眠れる！！最高！！！！」となります。</p><p>一方のアプリ開発チーム側から見ると「Kubernetesが勝手にWebサーバ再起動した！！！こっちはサービス提供時間中だぞ！！！ひどい！！！今までは1台ずつ丁寧に夜間手作業でやってくれてたじゃないか！！！」</p><p>そしてここではじめて、システム運用者のありがたみを心から知ることになります。</p><p>つまり、、、、、このような悲惨なすれ違いをなくすには
<strong>「今までシステム運用者がやっていた1-3の作業はどうなる？」</strong>
を深堀りしたアプリケーション方式設計/基盤方式設計が必要だということがわかります。</p><hr><p>Graceful Shutdownとは、アプリケーションをシャットダウンする前に、まだ進行中の要求を完了するためのタイムアウト期間を設け、その間に安全にアプリケーションを終了させることです。タイムアウト期間中に、すでに動いているアプリの処理の終了やDBなど外部サービスへの接続を停止する処理を行い、それが完了したらシャットダウンを行うことでデータのロストやコネクションのクローズ処理、アプリ不整合やエラーを防ぐことができます。</p><p>Spring boot 2.3.0.RELEASE以降では、フレームワーク自体にGraceful Shutdownの機能が追加されました。この機能は現在Tomcat/Undertow/Netty/JettyのWebサーバで提供されており、SmartLifecycleBeanを停止する最初のフェーズで実行されます。</p><p>なおアプリケーションが新しい要求を停止する方法は、Webサーバによって異なりますが公式ドキュメントによると、Tomcat/Jetty/Nettyはネットワーク層でのリクエストの受け入れを停止し、Undertowはリクエストを受け入れるもののHTTP503で応答します。</p><p><a href=https://docs.spring.io/spring-boot/docs/2.3.1.RELEASE/reference/htmlsingle/#boot-features-graceful-shutdown>Graceful Shutdown</a></p><p>では、具体的な実装例を見ていきましょう。</p><h1 id=spring-webfluxnettyでのgraceful-shutdown>Spring WebFlux/NettyでのGraceful Shutdown</h1><p>Spring WebFluxは、NettyなどのノンブロッキングI/Oベースのアプリケーションサーバ上で動作します。そして、ネットワークアクセスやDBアクセスなどのI/O処理の呼び出しに対して、1つのスレッドで複数のリクエストを処理でき少ないスレッドで実行できるため、メモリサイズやCPUの使用を減らすことが可能です。</p><p>Spring WebFluxでは、Reactorによるリアクティブプログラミングを採用しています。リアクティブプログラミングとは、データに着目したイベント駆動型のプログラミングの一種で、通知されるデータを受け取って処理を行うハンドラを実装することによって連続的なデータを処理する手法です。Reactorはリアクティブプログラミングを実現するためのライブラリの一つであり、ノンブロッキングで非同期なリアクティブプログラミングの仕組みを提供しています。</p><h2 id=spring-webfluxによるwebアプリケーションの作成>Spring WebFluxによるWebアプリケーションの作成</h2><p>Spring WebFluxを使ったWebアプリケーションは「Spring Initializr」を使ってプロジェクトのひな型を作成できます。その際、[ADD DEPENDENCIES]で[Spring Reactive Web]と[Spring Boot Actuator]を追加します。</p><p>ダウンロードしたZIPのpom.xmlを確認すると以下のdependencyが登録されています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;dependency</span><span style=color:#f92672>&gt;</span>
	<span style=color:#f92672>&lt;groupId</span><span style=color:#f92672>&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
	<span style=color:#f92672>&lt;artifactId</span><span style=color:#f92672>&gt;</span>spring-boot-starter-webflux<span style=color:#f92672>&lt;/artifactId&gt;</span>
<span style=color:#f92672>&lt;/dependency&gt;</span>
<span style=color:#f92672>&lt;dependency</span><span style=color:#f92672>&gt;</span>
	<span style=color:#f92672>&lt;groupId</span><span style=color:#f92672>&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
	<span style=color:#f92672>&lt;artifactId</span><span style=color:#f92672>&gt;</span>spring-boot-starter-actuator<span style=color:#f92672>&lt;/artifactId&gt;</span>
<span style=color:#f92672>&lt;/dependency&gt;</span>
</code></pre></div><h2 id=graceful-shutdownの設定>Graceful Shutdownの設定</h2><p>作成したアプリケーションのGraceful Shutdownの機能を有効にします。Mevenを使用している場合、<code>application.properties</code>に以下の設定を追加します。</p><pre><code class=language-properties data-lang=properties>server.shutdown=graceful
spring.lifecycle.timeout-per-shutdown-phase=60s
</code></pre><p>関連する設定値の意味は以下のとおりです。</p><table><thead><tr><th>設定値</th><th>意味</th></tr></thead><tbody><tr><td>server.shutdown: immediate</td><td>サーバの即時シャットダウン</td></tr><tr><td>server.shutdown: graceful</td><td>Graceful Shutdownの有効化</td></tr></tbody></table><p>Graceful Shutdownが有効化されると、シャットダウンまでの時間を<code>spring.lifecycle.timeout-per-shutdown-phase</code>で指定できます。これは<code>java.time.Duration</code>の値をとります。ここでは<code>60s</code>を指定しました。</p><h2 id=controllerの実装>Controllerの実装</h2><p>リクエストを受けるためのシンプルなControllerを書きます。'/sleep'にリクエストが来たら60s待って画面を返すだけです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.context.annotation.ComponentScan<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.stereotype.Controller<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.ui.Model<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.web.bind.annotation.GetMapping<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> lombok.extern.slf4j.Slf4j<span style=color:#f92672>;</span>

<span style=color:#a6e22e>@Slf4j</span>
<span style=color:#a6e22e>@ComponentScan</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;com.example.front.service&#34;</span><span style=color:#f92672>)</span>
<span style=color:#a6e22e>@Controller</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FrontController</span> <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>index</span><span style=color:#f92672>(</span>Model model<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Mapping: Index&#34;</span><span style=color:#f92672>)</span><span style=color:#f92672>;</span>
        model<span style=color:#f92672>.</span><span style=color:#a6e22e>addAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;host&#34;</span><span style=color:#f92672>,</span> getHost<span style=color:#f92672>(</span><span style=color:#f92672>)</span><span style=color:#f92672>)</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;index&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/sleep&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>Model model<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Sleep: 60s&#34;</span><span style=color:#f92672>)</span><span style=color:#f92672>;</span>
        Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>60_000L<span style=color:#f92672>)</span><span style=color:#f92672>;</span> 
        model<span style=color:#f92672>.</span><span style=color:#a6e22e>addAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;message&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34; Graceful shutdown complete&#34;</span><span style=color:#f92672>)</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;sleep&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>次のコマンドでWebサーバを起動します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./mvnw spring-boot:run
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> --- spring-boot-maven-plugin:2.5.4:run <span style=color:#f92672>(</span>default-cli<span style=color:#f92672>)</span> @ demo ---
<span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> Attaching agents: <span style=color:#f92672>[</span><span style=color:#f92672>]</span>

  .   ____          _            __ _ _
 /<span style=color:#ae81ff>\\</span> / ___<span style=color:#e6db74>&#39;_ __ _ _(_)_ __  __ _ \ \ \ \
</span><span style=color:#e6db74>( ( )\___ | &#39;</span>_ | <span style=color:#e6db74>&#39;_| | &#39;</span>_ <span style=color:#ae81ff>\/</span> _<span style=color:#e6db74>`</span> | <span style=color:#ae81ff>\ </span><span style=color:#ae81ff>\ </span><span style=color:#ae81ff>\ </span><span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span> <span style=color:#ae81ff>\\</span>/  ___<span style=color:#f92672>)</span>| |_<span style=color:#f92672>)</span>| | | | | <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>_| |  <span style=color:#f92672>)</span> <span style=color:#f92672>)</span> <span style=color:#f92672>)</span> <span style=color:#f92672>)</span>
  <span style=color:#e6db74>&#39;  |____| .__|_| |_|_| |_\__, | / / / /
</span><span style=color:#e6db74> =========|_|==============|___/=/_/_/_/
</span><span style=color:#e6db74> :: Spring Boot ::                (v2.5.4)
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>2021-09-30 13:15:06.043  INFO 5095 --- [           main] c.e.front.controller.FrontApplication    : Starting FrontApplication using Java 11.0.9.1 on xxx with PID 5095 ()
</span><span style=color:#e6db74>2021-09-30 13:15:06.060  INFO 5095 --- [           main] c.e.front.controller.FrontApplication    : No active profile set, falling back to default profiles: default
</span><span style=color:#e6db74>2021-09-30 13:15:14.498  INFO 5095 --- [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 14 endpoint(s) beneath base path &#39;</span>/actuator<span style=color:#960050;background-color:#1e0010>&#39;</span>
2021-09-30 13:15:15.627  INFO <span style=color:#ae81ff>5095</span> --- <span style=color:#f92672>[</span>           main<span style=color:#f92672>]</span> o.s.b.web.embedded.netty.NettyWebServer  : Netty started on port <span style=color:#ae81ff>8080</span>
2021-09-30 13:15:15.673  INFO <span style=color:#ae81ff>5095</span> --- <span style=color:#f92672>[</span>           main<span style=color:#f92672>]</span> c.e.front.controller.FrontApplication    : Started FrontApplication in 11.977 seconds <span style=color:#f92672>(</span>JVM running <span style=color:#66d9ef>for</span> 13.529<span style=color:#f92672>)</span>
</code></pre></div><p>これでテストを行います。</p><h3 id=アプリのリクエストが無い場合>アプリのリクエストが無い場合</h3><p>なにもリクエストが無い状態で、Webサーバを停止します。すると、Nettyはgraceful shutdownを行いますが、即時にサーバが停止します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>2021-09-30 13:19:21.418  INFO <span style=color:#ae81ff>5095</span> --- <span style=color:#f92672>[</span>ionShutdownHook<span style=color:#f92672>]</span> o.s.b.w.embedded.netty.GracefulShutdown  : Commencing graceful shutdown. Waiting <span style=color:#66d9ef>for</span> active requests to complete
2021-09-30 13:19:21.429  INFO <span style=color:#ae81ff>5095</span> --- <span style=color:#f92672>[</span> netty-shutdown<span style=color:#f92672>]</span> o.s.b.w.embedded.netty.GracefulShutdown  : Graceful shutdown complete
</code></pre></div><h3 id=終了待ちアプリのリクエストがある場合>終了待ちアプリのリクエストがある場合</h3><p>次は<code>/sleep</code>にアクセスした状態でWebサーバを停止します。すると、NettyはGraceful Shutdownを行いますが、<code>spring.lifecycle.timeout-per-shutdown-phase</code>で指定した時間待機してシャットダウンを行っています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>2021-09-30 13:23:42.867  INFO <span style=color:#ae81ff>5662</span> --- <span style=color:#f92672>[</span>or-http-epoll-3<span style=color:#f92672>]</span> c.e.front.controller.FrontController     : Sleep: 30s
2021-09-30 13:23:48.593  INFO <span style=color:#ae81ff>5662</span> --- <span style=color:#f92672>[</span>ionShutdownHook<span style=color:#f92672>]</span> o.s.b.w.embedded.netty.GracefulShutdown  : Commencing graceful shutdown. Waiting <span style=color:#66d9ef>for</span> active requests to complete
2021-09-30 13:24:48.594  INFO <span style=color:#ae81ff>5662</span> --- <span style=color:#f92672>[</span>ionShutdownHook<span style=color:#f92672>]</span> o.s.c.support.DefaultLifecycleProcessor  : Failed to shut down <span style=color:#ae81ff>1</span> bean with phase value <span style=color:#ae81ff>2147483647</span> within timeout of 60000ms: <span style=color:#f92672>[</span>webServerGracefulShutdown<span style=color:#f92672>]</span>
2021-09-30 13:24:48.627  INFO <span style=color:#ae81ff>5662</span> --- <span style=color:#f92672>[</span> netty-shutdown<span style=color:#f92672>]</span> o.s.b.w.embedded.netty.GracefulShutdown  : Graceful shutdown aborted with one or more requests still active
</code></pre></div><p>Sping Bootでは<code>SmartLifecycle</code>を実装したクラスは<code>ApplicationContext</code>の起動時やシャットダウン時に<code>start</code>/<code>stop</code>メソッドが呼ばれます。ソースをみてみると、Graceful Shutdownはこの<code>SmartLifecycle</code>インターフェースを実装した<code>WebServerGracefulShutdownLifecycle</code>の<code>stop</code>メソッドを呼び出しているのがわかります。</p><p><a href=https://github.com/spring-projects/spring-boot/blob/main/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/web/context/WebServerGracefulShutdownLifecycle.java>WebServerGracefulShutdownLifecycle.java</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>	<span style=color:#a6e22e>@Override</span>
	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stop</span><span style=color:#f92672>(</span>Runnable callback<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>running</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>webServer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>shutDownGracefully</span><span style=color:#f92672>(</span><span style=color:#f92672>(</span>result<span style=color:#f92672>)</span> <span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span> callback<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span><span style=color:#f92672>)</span><span style=color:#f92672>)</span><span style=color:#f92672>;</span>
	<span style=color:#f92672>}</span>
</code></pre></div><p>このようにSpringではプロパティで設定できるようになっています。</p><h1 id=kubernetesでのgraceful-shutdown>KubernetesでのGraceful Shutdown</h1><p>では、作成したアプリをKuberntesで動かしてみます。</p><h2 id=kubbernetesでのpod作成>KubbernetesでのPod作成</h2><p>まず作成したSpringアプリをKubernetesで動かすためには、アプリをコンテナ化する必要があります。自前でDockerfileを作成しても良いですが、Cloud Native Buildpacksを使うと便利です。Cloud Native Buildpacksとは、コンテナイメージを作るツールで、CNCFのincubating projectになっています。</p><p><a href=https://buildpacks.io/>Cloud Native Buildpacks</a></p><p>次のコマンドでコンテナイメージが作成できます。Kubernetesで利用するには、でき上がったDocker imageを任意のコンテナレジストリにPushしておきます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./mvnw spring-boot:build-image -Dspring-boot.build-image.imageName<span style=color:#f92672>=</span>xxx/frontend:v1.0.0

docker push xxx/frontend:v1.0.0
</code></pre></div><p>Kubernetesクラスタをデプロイします。ローカルで確認するときはminikubeでもいいですしクラウドのマネージドを使うのも便利です。
Azureの場合、<a href=https://docs.microsoft.com/ja-jp/azure/aks/kubernetes-walkthrough>Azure Kubernetes Service</a>だと数分でクラスタをデプロイできます。</p><p>クラスタができたら、Kuberntes Manifestを作成します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: apps/v1
<span style=color:#66d9ef>kind</span>: Deployment
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>labels</span>:
    <span style=color:#66d9ef>app</span>: front
  <span style=color:#66d9ef>name</span>: front
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>matchLabels</span>:
      <span style=color:#66d9ef>app</span>: front
  <span style=color:#66d9ef>template</span>:
    <span style=color:#66d9ef>metadata</span>:
      <span style=color:#66d9ef>labels</span>:
        <span style=color:#66d9ef>app</span>: front
    <span style=color:#66d9ef>spec</span>:
      <span style=color:#66d9ef>containers</span>:
        - <span style=color:#66d9ef>image</span>: xxx.azurecr.io/frontend:v1<span style=color:#ae81ff>.0</span><span style=color:#ae81ff>.0</span>
          <span style=color:#66d9ef>name</span>: front
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: v1
<span style=color:#66d9ef>kind</span>: Service
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>labels</span>:
    <span style=color:#66d9ef>app</span>: front
  <span style=color:#66d9ef>name</span>: frontend
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>ports</span>:
  - <span style=color:#66d9ef>name</span>: front-port
    <span style=color:#66d9ef>port</span>: <span style=color:#ae81ff>80</span>
    <span style=color:#66d9ef>protocol</span>: TCP
    <span style=color:#66d9ef>targetPort</span>: <span style=color:#ae81ff>8080</span>
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>app</span>: front
  <span style=color:#66d9ef>type</span>: LoadBalancer
</code></pre></div><p>作成したManifestをクラスタに反映します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f deployment.yaml
kubectl apply -f service.yaml
</code></pre></div><h2 id=podの削除処理を行うとどうなるか>Podの削除処理を行うとどうなるか？</h2><p>KubernetesでPodをアプリを提供するのですが、改めてPodの削除処理について詳細を見ていきます。</p><p>次のコマンドでPod <code>frontend</code>を削除します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete pod frontend-xxx
</code></pre></div><p>このコマンドを実行すると、Kuberntesクラスタでは以下の処理が行われます。</p><h3 id=lbからの切り離し>LBからの切り離し</h3><p>KubernetesではオンプレWeb3層システムでいうところの「LBの切り離し」に相当する、以下の処理がMaster Nodeで行われます。</p><ol><li><p>KubernetesのMaster Node上の<code>api-server</code>が<code>kubectl delete pod</code> コマンドを受け取ります。</p></li><li><p><code>Endpoint Controller</code>によってインターセプトされます。</p></li><li><p><code>Endpoint Controller</code>は、<code>api-server</code>にコマンドを発行して、エンドポイントオブジェクトからIPアドレスとポートを削除します。</p></li><li><p><code>Endpoint Controller</code>の変更情報を<code>kube-proxy</code>/<code>Ingress Controller</code>/<code>CoreDNS</code>/<code>kube-proxy</code>が受け取ります。</p></li></ol><p><img src=https://learnk8s.io/a/e1d6b1c2a0da6fea4b23038465063b60.svg alt="delete pod master"></p><h3 id=webサーバの停止>Webサーバの停止</h3><p>KubernetesではオンプレWeb3層システムでいうところの「Webサーバの停止」に相当する、以下の処理がWorker Nodeで行われます。</p><ol><li><p>KubernetesのWorker Node上の<code>kubelet</code>が<code>kubectl delete pod</code> コマンドを受け取ります。</p></li><li><p><code>kubelet</code>が<code>API Server</code>をポーリングしてPodの削除情報を更新します。</p></li><li><p>kubeletは、該当Podの破棄を<code>Container Runtime Interface(CRI)</code>/<code>Container Network Interface(CNI)</code>/<code>Container Storage Interface(CSI)</code>に委任します。</p></li></ol><p><img src=https://learnk8s.io/a/e889ef53f44dd44beaf693dccef3fe96.svg alt="delete pod worker"></p><p>実はこの2つの処理は並行して行われます。そのため、Master Nodeでの処理が完全に終わる前にPodが削除された場合、とても悲しいことになります。</p><p><img src=https://learnk8s.io/a/977b9cae783055d138b472476c0de4d9.svg alt="delete pod master"></p><p>従来のオンプレでのWeb3層システムの場合、システムメンテナンスなどでWebサーバを停止させる場合、システム運用者によってLBからの切り離しが終わってからWebサーバのシャットダウンをかけるといいましたが</p><p><strong>「LBからの切り離しとWebサーバの切り離しを同時かつ別々に始める！LBから切り離されたかどうかは知らんが、Webサーバは停止するぞ！」</strong></p><p>という動きになります。</p><p>・</p><p>・</p><p>・</p><p>しょぼん。</p><p>しかも、インフラ担当とアプリ担当が異なるプロジェクトの場合、「そんなはずじゃなかった」「そっちがよしなにやってくれると思っていた」に陥りがちなポイントです。</p><h2 id=kubernetes-でのgraceful-shutdown>Kubernetes でのGraceful Shutdown</h2><p>このように、Endpointが<code>kube-proxy</code>または<code>Ingress Controller</code>から削除される前にPodが終了すると、ダウンタイムが発生する可能性があります。</p><p>なぜならKubernetesは引き続きトラフィックをPodのIPアドレス宛にルーティングしていますが、Podは削除されていてすでに存在しない状態だからです。</p><p>ではどうすればよいかというと<code>Ingress Controller</code>/<code>kube-proxy</code>/<code>CoreDNS</code>などが該当PodのIPアドレスを削除しおわったのを待ってから、実際にPodを削除すればよいのでは？となります。</p><p>Kuberntesでは通常<code>SIGTERM</code>シグナルを送信し、30秒待ってからプロセスを強制終了します。この時間を調整できるオプションが、<code>terminationGracePeriodSeconds</code>です。</p><p><code>terminationGracePeriodSeconds</code>の指定はPodのマニフェストに記述します。これを指定することで、API ServerはPodの削除のリクエストを受け取ると、削除対象のPodリソースのMetadataに<code>deletionTimestamp</code> (削除されるであろう日時) と <code>deletionGracePeriodSeconds</code> (削除猶予時間) を設定し、<code>etcd</code> に書き込みます。</p><p>次のマニフェストは180s待って削除する例です。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    <span style=color:#66d9ef>spec</span>:
      <span style=color:#66d9ef>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>180</span>
      <span style=color:#66d9ef>containers</span>:
        - <span style=color:#66d9ef>image</span>: xxx.azurecr.io/frontend:v1<span style=color:#ae81ff>.0</span><span style=color:#ae81ff>.0</span>
          <span style=color:#66d9ef>name</span>: front
</code></pre></div><p>またPodに<code>preStop hook</code>を設定できます。<code>preStop hook</code>は Podのシャットダウンプロセスの最初に実行され、コンテナを正常終了させるために任意のコマンド (exec)や HTTP GET (httpGet)、TCP Socket (tcpSocket)のアクションを選択できます。</p><p>なおこの<code>preStop hook</code>は同期処理である必要があります。もしコマンドが非同期で終了処理を行ってしまうと、<code>kubelet</code>は<code>preStop hook</code>が終了したと判断し、次の処理に遷移するので注意です。</p><p><img src=https://learnk8s.io/a/b7a0400e6ebdb90e90b8cdf70c40a068.svg alt></p><p><code>preStop hook</code>を設定するには、Podのマニフェストを次のように指定します。次の例では180秒間<code>sleep</code>を実行します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>          <span style=color:#66d9ef>lifecycle</span>:
            <span style=color:#66d9ef>preStop</span>:
              <span style=color:#66d9ef>exec</span>:
                <span style=color:#66d9ef>command</span>: [<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;sleep 180&#34;</span>]
</code></pre></div><p>というわけで、全体をまとめたDeploymentは以下のようになります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: apps/v1
<span style=color:#66d9ef>kind</span>: Deployment
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>labels</span>:
    <span style=color:#66d9ef>app</span>: front
  <span style=color:#66d9ef>name</span>: front
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>matchLabels</span>:
      <span style=color:#66d9ef>app</span>: front
  <span style=color:#66d9ef>template</span>:
    <span style=color:#66d9ef>metadata</span>:
      <span style=color:#66d9ef>labels</span>:
        <span style=color:#66d9ef>app</span>: front
    <span style=color:#66d9ef>spec</span>:
      <span style=color:#66d9ef>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>180</span>
      <span style=color:#66d9ef>containers</span>:
        - <span style=color:#66d9ef>image</span>: xxx.azurecr.io/frontend:v1<span style=color:#ae81ff>.0</span><span style=color:#ae81ff>.0</span>
          <span style=color:#66d9ef>name</span>: front
          <span style=color:#66d9ef>resources</span>: {}
          <span style=color:#66d9ef>lifecycle</span>:
            <span style=color:#66d9ef>preStop</span>:
              <span style=color:#66d9ef>exec</span>:
                <span style=color:#66d9ef>command</span>: [<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;sleep 180&#34;</span>]
</code></pre></div><p>めでたしめでたし。</p><p>このあたりのパラメータをどう設定すればよいかについては、アプリケーションによりけりなので、開発チームとインフラチームで密連携して設計・テストが必要になってきます。</p><p>また、モニタリングのしくみも整備し、Podの生き死にでエンドユーザに影響が出ていないかや、Worker Nodeへのカオス注入などでプラットフォームのメンテナンスを想定した総合テストなども必要になってきます。</p><blockquote><p><strong>Graceful Node Shutdown</strong></p><p>なお、Kubernetes 1.21 betaより<a href=ttps://kubernetes.io/blog/2021/04/21/graceful-node-shutdown-beta/>Graceful Node Shutdown</a>がサポートされ、&ndash;configフラグを介してkubeletに渡されるkubelet configによって構成を変更できます。クラウドのマネージドサービスでの対応など今後も注目です。</p></blockquote><h2 id=まとめ>まとめ</h2><p>このように、クラウドネイティブな環境でアプリケーションを動かすためには、GracefulなShutdownを意識して実装する必要があります。</p><p>信頼性大事。可用性大事。クラウドネイティブな環境においては非機能要件はインフラチームだけの話じゃないのが奥深いところです。</p><p>以上</p><ul><li><a href=https://qiita.com/superbrothers/items/3ac78daba3560ea406b2>参考: Kubernetes: 詳解 Pods の終了</a></li><li><a href=https://github.com/spring-projects/spring-boot/blob/main/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/web/context/WebServerGracefulShutdownLifecycle.java>参考: WebServerGracefulShutdownLifecycle.java</a></li><li><a href=https://learnk8s.io/graceful-shutdown>参考: Graceful shutdown and zero downtime deployments in Kubernetes</a></li></ul></div></main></body></html>