<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=ja-jp lang=ja-jp><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.64.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Azure AppServiceでOpenID Connect プロバイダーを使用してログインする &#183; ASA Blog</title><meta name=description content="Azure AppServiceでOpenID Connect プロバイダーを使用して認証するための手順です。"><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://asashiho.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link type=text/css rel=stylesheet href=https://use.fontawesome.com/releases/v5.0.6/css/all.css><link type=text/css rel=stylesheet href=https://aakira.app/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css integrity=sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0 crossorigin=anonymous><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css integrity=sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js integrity=sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js integrity=sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF crossorigin=anonymous onload=renderMathInElement(document.body);></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"\\[",right:"\\]",display:true},{left:"$",right:"$",display:false},{left:"\\(",right:"\\)",display:false}]});});</script><meta property="og:site_name" content="ASA Blog"><meta property="og:title" content="Azure AppServiceでOpenID Connect プロバイダーを使用してログインする"><meta property="og:url" content="https://asashiho.github.io/appservice-oidc/appservice-oidc/"><meta property="og:type" content="article"><meta name=twitter:card content="summary"><meta name=twitter:site content="@_dr_asa"><meta name=twitter:creator content="@_dr_asa"><meta property="twitter:title" content="Azure AppServiceでOpenID Connect プロバイダーを使用してログインする"><meta property="og:description" content="Azure AppServiceでOpenID Connect プロバイダーを使用して認証するための手順です。"><meta property="twitter:description" content="Azure AppServiceでOpenID Connect プロバイダーを使用して認証するための手順です。"><meta property="og:image" content="https://asashiho.github.io/thumbnails/prof.jpg"><meta property="og:image:url" content="https://asashiho.github.io/thumbnails/prof.jpg"></head><body class=theme-base-0d><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://asashiho.github.io/><h1>ASA Blog</h1></a><p class=lead>enjoy a laid-back life</p></div><nav><ul class=sidebar-nav><li><a href=https://asashiho.github.io/>Home</a></li><li><a href=https://github.com/asashiho/>GitHub</a></li><li><a href=https://www.linkedin.com/in/shiho-asa/>LinkedIn</a></li></ul></nav><p>&copy; 2022. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Azure AppServiceでOpenID Connect プロバイダーを使用してログインする</h1><time datetime=2021-09-01T00:00:00Z class=post-date>Wed, Sep 1, 2021</time>
<a href="http://twitter.com/intent/tweet?url=https%3a%2f%2fasashiho.github.io%2fappservice-oidc%2fappservice-oidc%2f&text=Azure%20AppService%e3%81%a7OpenID%20Connect%20%e3%83%97%e3%83%ad%e3%83%90%e3%82%a4%e3%83%80%e3%83%bc%e3%82%92%e4%bd%bf%e7%94%a8%e3%81%97%e3%81%a6%e3%83%ad%e3%82%b0%e3%82%a4%e3%83%b3%e3%81%99%e3%82%8b" target=_blank title=Tweet><i class="fab fa-twitter"></i></a>&ensp;
<a href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fasashiho.github.io%2fappservice-oidc%2fappservice-oidc%2f&t=Azure%20AppService%e3%81%a7OpenID%20Connect%20%e3%83%97%e3%83%ad%e3%83%90%e3%82%a4%e3%83%80%e3%83%bc%e3%82%92%e4%bd%bf%e7%94%a8%e3%81%97%e3%81%a6%e3%83%ad%e3%82%b0%e3%82%a4%e3%83%b3%e3%81%99%e3%82%8b" target=_blank title=Facebook><i class="fab fa-facebook"></i></a>&ensp;
<a href="https://plus.google.com/share?url=https%3a%2f%2fasashiho.github.io%2fappservice-oidc%2fappservice-oidc%2f" target=_blank title=google+><i class="fab fa-google-plus"></i></a><hr><p><strong>※ 本エントリーは2021/09時点の内容になります。現在プレビュー機能のため内容が変更になる場合があります。</strong></p><p>AzureのAppServiceは、認証プロバイダとしてAzure AD/Facebook/Google/Twitterに加えて、OpenID Connectを選ぶことができます。
このエントリーは、OpenID Connect の仕様に準拠したカスタム認証プロバイダーを使用してAzure App Servicesを構成する方法を説明します。</p><h1 id=keycloakでopenid-connectプロバイダーを構築する>KeyCloakでOpenID Connectプロバイダーを構築する</h1><p>まずはじめに機能検証を行うために、OpenID Connectプロバイダーを構築します。既存のIDプロバイダーがある場合はそちらを使ってください。</p><h2 id=keycloakの検証環境構築>KeyCloakの検証環境構築</h2><p>ここでは、<a href=https://docs.microsoft.com/ja-jp/azure/container-instances/>Azure Container Instance</a>と<a href=https://www.keycloak.org/>KeyCloak</a>を使って簡易的なIDプロバイダを作成します。</p><p>まず、Azureの東日本リージョンにリソースグループを作成します</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az login
RG_NAME<span style=color:#f92672>=</span>keycloak
ACI_NAME<span style=color:#f92672>=</span>keycloak

az group create -n $RG_NAME -l japaneast
</code></pre></div><p>Azure Container Instanceは(ACI)、Azureが提供するコンテナ実行環境サービスです。
次のコマンドを実行してKeyCloakをAzure Container Instanceを起動します。
ここで、'&ndash;environment-variablesオプション&rsquo; でKeyCloakの管理者ユーザ名を&rsquo;KEYCLOAK_USER&rsquo;、パスワードを&rsquo;KEYCLOAK_PASSWORD'に設定します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az container create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -g $RG_NAME <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -n $ACI_NAME <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --image jboss/keycloak <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --dns-name-label aci-keycloak <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --ports <span style=color:#ae81ff>8080</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --environment-variables <span style=color:#e6db74>&#39;KEYCLOAK_USER&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;admin&#39;</span> <span style=color:#e6db74>&#39;KEYCLOAK_PASSWORD&#39;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;password&#39;</span>
</code></pre></div><p>次のコマンドを実行すると、ACIの完全修飾ドメイン名(FQDN)とそのプロビジョニング状態が表示されます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az container show <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -g $RG_NAME <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -n $ACI_NAME <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --query <span style=color:#e6db74>&#34;{FQDN:ipAddress.fqdn,ProvisioningState:provisioningState}&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --out table
</code></pre></div><p>ブラウザでKeyCloakのFQDNの8080ポートにアクセスします。
[Administration Console]から指定したKeyCloakの管理者ユーザ名/パスワードでログインします。</p><p><a href=http://xxxx.japaneast.azurecontainer.io>http://xxxx.japaneast.azurecontainer.io</a>:8080/</p><p><img src=../docs/images/admin.png alt></p><p>これで環境が作成できました。</p><h2 id=keycloakの設定>KeyCloakの設定</h2><p>続いて、[Administration Console]-[Clients]を選び、[Create]ボタンをクリックします。</p><p>[Add Client]画面で以下の項目を設定し、[Save]ボタンをクリックします。</p><table><thead><tr><th>設定項目</th><th>設定値</th></tr></thead><tbody><tr><td>Client ID</td><td>keycloak</td></tr><tr><td>Client Protocol</td><td>openid-connect</td></tr></tbody></table><p><img src=../docs/images/addclient.png alt></p><p>次に、KeyCloakの画面で[Access Type]を[confidential]を選び、[Valid Redirect URIs]に「*」を入力し、[Save]ボタンをクリックします。</p><p><img src=../docs/images/confidential.png alt></p><p>ここで、KeyCloakのCredentialを取得します。[Credentials]タブを開き[Secret]に表示された値を後で使用するためにメモします。</p><p><img src=../docs/images/keycloak-secret.png alt></p><p>また、動作確認を行う際にKeyCloakに任意のユーザを登録しておきましょう。</p><p><img src=../docs/images/user-add.png alt></p><p>KeyCloakの環境構築に関しては、<a href=https://www.keycloak.org/>公式ドキュメント</a>を参照するか、<a href=https://openstandia.jp/oss_info/keycloak/>野村総合研究所のOpenStandiaメンバー</a>中心でメンテされている<a href=https://keycloak-documentation.openstandia.jp/>和訳サイト</a>を参照してください。</p><h1 id=appservice-でwebアプリを作成する>AppService でWebアプリを作成する</h1><h2 id=nodejs-アプリケーションの作成>Node.js アプリケーションの作成</h2><p>認証を設定するサンプルのNode.jsアプリケーションを作成します。
次のコマンドでExpress ジェネレーターツールを使用して新しいExpressアプリケーションをスキャフォールディングします。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>npx express-generator myExpressApp --view pug --git
</code></pre></div><p>アプリケーションの依存関係をインストールするために、新しいフォルダーに移動して npm install を実行します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cd myExpressApp
npm install
</code></pre></div><p>ローカル環境でアプリケーションが動作することを確認します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>npm start
</code></pre></div><p>ブラウザでhttp://localhost:3000 にアクセスし動作確認を行います。</p><p>つぎにOpenID Connect プロバイダーを使用してログインできるよう、App Serviceの認証を設定します。
ここでは、Expressアプリケーションのルートフォルダ「myExpressApp」配下にauth.jsonという名前のファイルを作成します。</p><p>これを以下のサンプルをもとに書き換えます。</p><p>ここで変更すべき箇所は
[identityProviders]-[openIdConnectProviders]-[kaycloak]-[registration]-[openIdConnectConfiguration]の[wellKnownOpenIdConfiguration]の値を、上記で順で構築した検証用のACIのFQDNに変更します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;platform&#34;</span>: {
        <span style=color:#f92672>&#34;enabled&#34;</span>: <span style=color:#66d9ef>true</span>
    },
    <span style=color:#f92672>&#34;globalValidation&#34;</span>: {
        <span style=color:#f92672>&#34;redirectToProvider&#34;</span>: <span style=color:#e6db74>&#34;keycloak&#34;</span>,
        <span style=color:#f92672>&#34;unauthenticatedClientAction&#34;</span>: <span style=color:#e6db74>&#34;RedirectToLoginPage&#34;</span>
    },
    <span style=color:#f92672>&#34;identityProviders&#34;</span>: {
        <span style=color:#f92672>&#34;openIdConnectProviders&#34;</span>: {
            <span style=color:#f92672>&#34;keycloak&#34;</span>: {
                <span style=color:#f92672>&#34;enabled&#34;</span>: <span style=color:#66d9ef>true</span>,
                <span style=color:#f92672>&#34;registration&#34;</span>: {
                    <span style=color:#f92672>&#34;clientId&#34;</span>: <span style=color:#e6db74>&#34;keycloak&#34;</span>,
                    <span style=color:#f92672>&#34;clientCredential&#34;</span>: {
                        <span style=color:#f92672>&#34;clientSecretSettingName&#34;</span>: <span style=color:#e6db74>&#34;KEYCLOAK_CLIENT_SECRET&#34;</span>
                    },
                    <span style=color:#f92672>&#34;openIdConnectConfiguration&#34;</span>: {
                        <span style=color:#f92672>&#34;wellKnownOpenIdConfiguration&#34;</span>: <span style=color:#e6db74>&#34;http://&lt;your_acr_name&gt;.japaneast.azurecontainer.io:8080/auth/realms/master/.well-known/openid-configuration&#34;</span>
                    }
                },
                <span style=color:#f92672>&#34;login&#34;</span>: {
                    <span style=color:#f92672>&#34;nameClaimType&#34;</span>: <span style=color:#e6db74>&#34;name&#34;</span>,
                    <span style=color:#f92672>&#34;scopes&#34;</span>: [
                        <span style=color:#e6db74>&#34;openid&#34;</span>
                    ],
                    <span style=color:#f92672>&#34;loginParameterNames&#34;</span>: []
                }
            }
        }
    },
    <span style=color:#f92672>&#34;login&#34;</span>: {
        <span style=color:#f92672>&#34;tokenStore&#34;</span>: {
            <span style=color:#f92672>&#34;enabled&#34;</span>: <span style=color:#66d9ef>true</span>
        }
    }     
}
</code></pre></div><p>また、KeyCloakのSecretはこのファイルに直接記述せずに、AppServiceのアプリケーション設定で指定した値(キー名: KEYCLOAK_CLIENT_SECRET)を参照します。</p><h2 id=appserviceへのデプロイ>AppServiceへのデプロイ</h2><p>アプリケーションの準備ができたので、Visual Studio Codeの拡張機能を使用してAppServiceのLinux環境にデプロイします。</p><p>コマンドパレット(Ctrl + Shift + P) から「deploy to web app」と入力し、Azure App Service: Deploy to Web App コマンドを実行します。
次に、[Create new Web App](新しい Web アプリの作成) を選択します。Webアプリ名にグローバルに一意な名前を入力し、Enter キーをクリックます。</p><p>デプロイ手順の詳細については、<a href="https://docs.microsoft.com/ja-jp/azure/app-service/quickstart-nodejs?pivots=platform-linux">公式ドキュメント「Azure で Node.js Web アプリを作成する」</a>を参照してください。</p><p>次に、KeyCloakのSecretをWebAppsのアプリケーション設定に登録します。
Azureポータルにアクセスし、作成したWebAppsの[設定]-[構成]-[アプリケーション設定の追加]で以下を登録します。</p><table><thead><tr><th>設定項目</th><th>設定値</th></tr></thead><tbody><tr><td>名前</td><td>KEYCLOAK_CLIENT_SECRET</td></tr><tr><td>値</td><td>KeyCloakで取得したSecretの値¦</td></tr></tbody></table><p><img src=../docs/images/app-secret.png alt></p><h2 id=ファイルベースの構成の有効化>ファイルベースの構成の有効化</h2><p>現時点で、WebAppsでOIDCを使った認証を有効にするためには、<a href=https://docs.microsoft.com/ja-jp/azure/app-service/configure-authentication-file-based>ファイルベースの構成の有効化</a>が必要になります。</p><p>ブラウザで<a href=https://resources.azure.com>Resource Explroer（https://resources.azure.com）</a>を開きます。</p><p>次にツリーから [subscriptions] - [&lt;お使いのサブスクリプション>] - [resourceGroups] - [&lt;WebAppsのリソースグループ名>] - [providers] - [Microsoft.Web] - [sites] - [&lt;WebApps名>] - [config] - [authsettingsV2] を選び、以下の項目を設定します。</p><p>ここで、configFilePathに、auth.jsonのファイルパスを指定してください。Linuxの場合は以下のようになります。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>  <span style=color:#e6db74>&#34;properties&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
    <span style=color:#f92672>&#34;platform&#34;</span>: {
      <span style=color:#f92672>&#34;enabled&#34;</span>: <span style=color:#66d9ef>true</span>,
      <span style=color:#f92672>&#34;configFilePath&#34;</span>: <span style=color:#e6db74>&#34;/home/site/wwwroot/auth.json&#34;</span>
    }
  }
</code></pre></div><p><img src=../docs/images/res.png alt></p><p>この設定後は Azure Portal から App Service Authentication の設定が出来なくなるため、変更したい場合は Resource Explroer か Azure CLI を使う必要があります。</p><p>設定が完了したら、WebAppsを再起動します。</p><p>詳細な手順は、<a href=https://docs.microsoft.com/ja-jp/azure/app-service/configure-authentication-provider-openid-connect>公式ドキュメント「OpenID Connect プロバイダーを使用してログインするように App Service または Azure Functions アプリを構成する (プレビュー)」</a>を参照してください。</p><p>また、より詳細な情報は<a href=https://blog.shibayan.jp/entry/20201209/1607487134>しばやん雑記-App Service Authentication が OpenID Connect Provider をサポートするようになった</a>が大変参考になりました！ありがとうございます。</p><h1 id=動作確認>動作確認</h1><p>これで設定が完了しましたので、WebAppsにデプロイしたサンプルアプリにアクセスします。</p><p>KeyCloakの認証ダイアログが表示されるので、KeyCloakで設定したユーザ名とパスワードを使用してログインします。認証に成功すると、サンプルアプリが表示されます。</p><p><img src=../docs/images/login.png alt></p><p><img src=../docs/images/success.png alt></p><h2 id=clean-up>clean up</h2><p>次のコマンドを実行して、検証環境を削除します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az group delete -n $RG_NAME
</code></pre></div><h2 id=まとめ>まとめ</h2><p>本エントリーでは、App ServiceにデプロイしたWebサービスをOpenID Connect プロバイダーを使用して認証する手順をまとめました。これは現在プレビュー機能のため、今後は変更になる可能性があります。</p><p>最新の情報は、<a href=https://docs.microsoft.com/ja-jp/azure/app-service/configure-authentication-provider-openid-connect>公式ドキュメント</a>を参照してください。</p><p>以上</p></div></main></body></html>